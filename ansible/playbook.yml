---
- name: Deploy multi Laravel apps
  hosts: target_servers
  become: yes

  vars:
    apps:
      - name: "siimut"
        user: "siimut"
        repo: "https://github.com/juniyasyos/si-imut.git"
        branch: "iam-integration"
        dir: "/opt/siimut"
        compose: "docker-compose.yml"

      - name: "iam"
        user: "iam"
        repo: "https://github.com/juniyasyos/laravel-iam.git"
        branch: "main"
        dir: "/opt/iam"
        compose: "docker-compose.yml"

      - name: "client"
        user: "client"
        repo: "https://github.com/juniyasyos/client-iiam.git"
        branch: "main"
        dir: "/opt/client"
        compose: "docker-compose.yml"

  tasks:
    # =========================================================
    # create user per aplikasi
    # =========================================================
    - name: Create application users
      user:
        name: "{{ item.user }}"
        shell: /bin/bash
        create_home: yes
        groups: docker
        append: yes
      loop: "{{ apps }}"
      loop_control:
        label: "{{ item.user }}"

    # =========================================================
    # create direktori per aplikasi
    # =========================================================
    - name: Create app directory
      file:
        path: "{{ item.dir }}"
        state: directory
        owner: "{{ item.user }}"
        group: "{{ item.user }}"
        mode: 0755
      loop: "{{ apps }}"
      loop_control:
        label: "{{ item.dir }}"

    # =========================================================
    # clone repo aplikasi
    # =========================================================
    - name: Clone app repository
      git:
        repo: "{{ item.repo }}"
        dest: "{{ item.dir }}/src"
        version: "{{ item.branch }}"
        force: yes
      become_user: "{{ item.user }}"
      loop: "{{ apps }}"
      loop_control:
        label: "{{ item.name }}"

    # =========================================================
    # copy docker compose file
    # =========================================================
    - name: Copy docker compose file
      copy:
        src: "{{ item.compose }}"
        dest: "{{ item.dir }}/docker-compose.yml"
        owner: "{{ item.user }}"
        group: "{{ item.user }}"
        mode: "0644"
      loop: "{{ apps }}"

    # =========================================================
    # systemd service (per aplikasi)
    # =========================================================
    - name: Create systemd service
      template:
        src: app.service.j2
        dest: "/etc/systemd/system/{{ item.name }}.service"
        mode: "0644"
      loop: "{{ apps }}"
      notify: reload_systemd

    # =========================================================
    # enable & start service
    # =========================================================
    - name: Start & enable service
      systemd:
        name: "{{ item.name }}"
        state: started
        enabled: yes
      loop: "{{ apps }}"

  handlers:
    - name: reload_systemd
      systemd:
        daemon_reload: yes
