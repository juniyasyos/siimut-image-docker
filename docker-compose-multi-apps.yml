name: service-app

####################################################################################################
# Base APP PHP Application - Unified with Supervisor (Hospital Single-App)
####################################################################################################
x-app-base: &app-base
  working_dir: /var/www/html
  env_file:
    - .env.production # bisa diganti per-app nanti
  environment:
    PHP_OPCACHE_VALIDATE_TIMESTAMPS: "${PHP_OPCACHE_VALIDATE_TIMESTAMPS:-0}"
    COMPOSER_CACHE_DIR: /tmp/composer
    APP_ENV: ${APP_ENV:-production}
    RUN_MIGRATIONS: ${RUN_MIGRATIONS:-false}
  depends_on:
    db:
      condition: service_healthy
  restart: unless-stopped
  deploy:
    resources:
      limits:
        memory: 1.5G
        cpus: "1.5"
      reservations:
        memory: 768M
        cpus: "0.75"
  healthcheck:
    test: ["CMD-SHELL", "php -v >/dev/null 2>&1"]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 60s

services:
  ####################################################################################################
  # Caddy Web Server - Production Optimized
  ####################################################################################################
  web:
    image: caddy:2-alpine
    container_name: ${STACK_NAME:-multi}-web
    ports:
      - "8088:8088"
      - "7000:7000"
      # - "443:443" # TLS support for production
    volumes:
      - ./DockerNew/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - siimut_public:/var/www/siimut/public:ro  # Public assets from SIIMUT
      - iam_public:/var/www/iam/public:ro        # Public assets from IAM
      - caddy_data:/data
      - caddy_config:/config
      - caddy_logs:/var/log/caddy
    depends_on:
      app-siimut:
        condition: service_healthy
      app-iam:
        condition: service_healthy
    restart: unless-stopped
    # Production resource limits
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"
        reservations:
          memory: 128M
          cpus: "0.25"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8088/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  ####################################################################################################
  ####################################################################################################
  # Section : Apps - Production Application
  ####################################################################################################
  ####################################################################################################

  ####################################################################################################
  # Apps SIIMUT
  ####################################################################################################
  app-siimut:
    image: ${REGISTRY:-juniyasyos}/siimut-app:${VERSION:-latest}
    container_name: siimut-app
    working_dir: /var/www/siimut
    env_file:
      - ./env/.env.siimut
    environment:
      APP_ENV: production
      PHP_OPCACHE_VALIDATE_TIMESTAMPS: "0"
      APP_WORKDIR: /var/www/siimut
      PUBLIC_VOLUME: /var/www/public-shared-siimut
      DB_HOST: database-service
    volumes:
      # Only persistent data, NO CODE mounts
      - siimut_storage:/var/www/siimut/storage
      - siimut_bootstrap_cache:/var/www/siimut/bootstrap/cache
      - siimut_public:/var/www/public-shared-siimut  # Shared with Caddy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1.5G
          cpus: "1.5"
        reservations:
          memory: 768M
          cpus: "0.75"
    healthcheck:
      test: ["CMD-SHELL", "php -v >/dev/null 2>&1 && php artisan --version >/dev/null 2>&1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      default:
        aliases:
          - siimut-app

  queue-siimut:
    image: ${REGISTRY:-juniyasyos}/siimut-app:${VERSION:-latest}
    container_name: siimut-queue
    working_dir: /var/www/siimut
    env_file:
      - ./env/.env.siimut
    environment:
      DB_HOST: database-service
    volumes:
      - siimut_storage:/var/www/siimut/storage
      - siimut_bootstrap_cache:/var/www/siimut/bootstrap/cache
    entrypoint: ["php"]
    command: >
      artisan queue:work --sleep=3 --tries=3
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.75"
        reservations:
          memory: 256M
          cpus: "0.25"

  scheduler-siimut:
    image: ${REGISTRY:-juniyasyos}/siimut-app:${VERSION:-latest}
    container_name: siimut-scheduler
    working_dir: /var/www/siimut
    env_file:
      - ./env/.env.siimut
    environment:
      DB_HOST: database-service
    volumes:
      - siimut_storage:/var/www/siimut/storage
      - siimut_bootstrap_cache:/var/www/siimut/bootstrap/cache
    entrypoint: ["php"]
    command: >
      artisan schedule:work
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"
        reservations:
          memory: 128M
          cpus: "0.25"


  ####################################################################################################
  # Apps IAM
  ####################################################################################################
  app-iam:
    image: ${REGISTRY:-juniyasyos}/iam-server:${VERSION:-latest}
    container_name: iam-app
    working_dir: /var/www/iam
    env_file:
      - ./env/.env.iam
    environment:
      APP_ENV: production
      PHP_OPCACHE_VALIDATE_TIMESTAMPS: "0"
      APP_WORKDIR: /var/www/iam
      PUBLIC_VOLUME: /var/www/public-shared-iam
      DB_HOST: database-service
    volumes:
      # Only persistent data, NO CODE mounts
      - iam_storage:/var/www/iam/storage
      - iam_bootstrap_cache:/var/www/iam/bootstrap/cache
      - iam_public:/var/www/public-shared-iam  # Shared with Caddy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1.5G
          cpus: "1.5"
        reservations:
          memory: 768M
          cpus: "0.75"
    healthcheck:
      test: ["CMD-SHELL", "php -v >/dev/null 2>&1 && php artisan --version >/dev/null 2>&1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      default:
        aliases:
          - iam-app


  ####################################################################################################
  ####################################################################################################
  # End Section: Apps - Production Application
  ####################################################################################################
  ####################################################################################################

####################################################################################################
# Named Volumes - Production Optimized (Multi Laravel Apps, No Redis)
####################################################################################################
volumes:
  # Web server data
  caddy_data:
    driver: local
  caddy_config:
    driver: local
  caddy_logs:
    driver: local

  # ====== PUBLIC ASSETS (untuk Caddy serve static files) ======
  siimut_public:
    driver: local
  iam_public:
    driver: local

  # ====== DATA PERSISTEN LARAVEL (tanpa vendor) ======
  # SIIMUT
  siimut_storage:
    driver: local
  siimut_bootstrap_cache:
    driver: local

  # IAM
  iam_storage:
    driver: local
  iam_bootstrap_cache:
    driver: local

####################################################################################################
# Networks - Production Security
####################################################################################################
networks:
  default:
    name: rsch-srv_default
    external: true