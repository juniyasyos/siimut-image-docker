################################################################################
# SIIMUT Development Compose Configuration
# 
# Purpose: Development environment for Siimut application
# Note: Database, Redis, and phpMyAdmin services are defined in the base
#       compose configuration (compose/compose.base.yml). Both files should
#       be run together using: 
#       docker-compose -f compose/compose.base.yml -f docker-compose.yml up
################################################################################

volumes:
  app_storage:

# Shared configuration for application services
x-app-service: &app-service
  image: juniyasyos/siimut-app:alpine-1.3.5
  restart: unless-stopped
  working_dir: /var/www
  volumes:
    - app_storage:/var/www
  networks:
    - siimut_network
    
services:

  ##############################################################################
  # PHP-FPM Application Server
  ##############################################################################
  app:
    <<: *app-service
    container_name: siimut-app-fpm
    ports:
      - "${VITE_PORT:-5173}:5173"
    healthcheck:
      test: ["CMD", "php", "-v"]
      interval: 30s
      timeout: 10s
      retries: 3

  ##############################################################################
  # Nginx Reverse Proxy / Web Server
  ##############################################################################
  web:
    image: nginx:alpine
    container_name: siimut-nginx
    restart: unless-stopped
    ports:
      - "${APP_PORT:-80}:80"
    volumes:
      - app_storage:/var/www
      - ./Docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./Docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      app:
        condition: service_started
    networks:
      - siimut_network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

  ##############################################################################
  # Background Job Worker & Scheduler
  ##############################################################################
  worker:
    <<: *app-service
    container_name: siimut-worker
    command: >
      sh -c "
        php artisan queue:work redis --sleep=3 --tries=3 &
        php artisan schedule:work
      "
    depends_on:
      - app

################################################################################
# Networks
################################################################################
networks:
  siimut_network:
    driver: bridge
