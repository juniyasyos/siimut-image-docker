name: service-app

services:
  ####################################################################################################
  # Nginx Web Server - Production Optimized
  ####################################################################################################
  web:
    image: nginx:alpine
    container_name: ${STACK_NAME:-multi}-web
    ports:
      - "${SIIMUT_PORT:-8000}:8000"
      ### - "${IAM_PORT:-8100}:8100"
    volumes:
      - ./DockerNew/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./DockerNew/nginx/nginx-multi-apps.conf:/etc/nginx/conf.d/default.conf:ro
      - siimut_public:/var/www/siimut/public:ro  # Public assets from SIIMUT
      ### - iam_public:/var/www/iam/public:ro        # Public assets from IAM
      - nginx_logs:/var/log/nginx
    depends_on:
      app-siimut:
        condition: service_healthy
      ### app-iam:
      ###   condition: service_healthy
    restart: unless-stopped
    # Production resource limits
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.2"
        reservations:
          memory: 128M
          cpus: "0.1"
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  ####################################################################################################
  ####################################################################################################
  # Section : Apps - Production Application
  ####################################################################################################
  ####################################################################################################

  ####################################################################################################
  # Apps SIIMUT
  ####################################################################################################
  app-siimut:
    build:
      context: .
      dockerfile: DockerNew/php/Dockerfile.siimut-registry
      args:
        APP_DIR: siimut
        APP_NAME: "SIIMUT Application"
        APP_ENV: production
    container_name: siimut-app
    working_dir: /var/www/siimut
    env_file:
      - ./env/.env.dev.siimut
    environment:
      APP_WORKDIR: /var/www/siimut
      PUBLIC_VOLUME: /var/www/public-shared-siimut
      DB_HOST: db
      DB_USER: siimut_user
      DB_PASSWORD: siimut-password
      ### # SSO Configuration - Override from compose
      ### USE_SSO: "true"
      ### IAM_ENABLED: "true"
      ### IAM_HOST: "http://192.168.1.9:8100"
      ### IAM_BASE_URL: "http://192.168.1.9:8100"
      ### APP_URL: "http://192.168.1.9:8000"
      ### IAM_LOGIN_ROUTE: "/login"
      ### IAM_CALLBACK_ROUTE: "/callback"
    volumes:
      # Mount kode aplikasi untuk development (bukan immutable)
      - ./site/siimut:/var/www/siimut
      # Master .env files untuk auto-sync
      - ./env:/var/www/env
      # Only persistent data, NO CODE mounts
      - siimut_storage:/var/www/siimut/storage
      - siimut_bootstrap_cache:/var/www/siimut/bootstrap/cache
      - siimut_public:/var/www/public-shared-siimut  # Shared with Caddy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1.5G
          cpus: "1.5"
        reservations:
          memory: 768M
          cpus: "0.75"
    healthcheck:
      test: ["CMD-SHELL", "php -v >/dev/null 2>&1 && php artisan --version >/dev/null 2>&1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      default:
        aliases:
          - siimut-app

  queue-siimut:
    build:
      context: .
      dockerfile: DockerNew/php/Dockerfile.siimut-registry
      args:
        APP_DIR: siimut
        APP_NAME: "SIIMUT Application"
        APP_ENV: production
    container_name: siimut-queue
    working_dir: /var/www/siimut
    env_file:
      - ./env/.env.siimut
    environment:
      DB_HOST: db
      DB_USER: siimut_user
      DB_PASSWORD: siimut-password
    volumes:
      - ./site/siimut:/var/www/siimut
      - siimut_storage:/var/www/siimut/storage
      - siimut_bootstrap_cache:/var/www/siimut/bootstrap/cache
    entrypoint: ["php"]
    command: >
      artisan queue:work --sleep=3 --tries=3
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.75"
        reservations:
          memory: 256M
          cpus: "0.25"

  scheduler-siimut:
    build:
      context: .
      dockerfile: DockerNew/php/Dockerfile.siimut-registry
      args:
        APP_DIR: siimut
        APP_NAME: "SIIMUT Application"
        APP_ENV: production
    container_name: siimut-scheduler
    working_dir: /var/www/siimut
    env_file:
      - ./env/.env.siimut
    environment:
      DB_HOST: db
      DB_USER: siimut_user
      DB_PASSWORD: siimut-password
    volumes:
      - ./site/siimut:/var/www/siimut
      - siimut_storage:/var/www/siimut/storage
      - siimut_bootstrap_cache:/var/www/siimut/bootstrap/cache
    entrypoint: ["php"]
    command: >
      artisan schedule:work
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"
        reservations:
          memory: 128M
          cpus: "0.25"


  ### ####################################################################################################
  ### # Apps IAM
  ### ####################################################################################################
  ### app-iam:
  ###   build:
  ###     context: .
  ###     dockerfile: DockerNew/php/Dockerfile.iam-registry
  ###     args:
  ###       APP_DIR: iam-server
  ###       APP_NAME: "IAM Server"
  ###       APP_ENV: production
  ###   container_name: iam-app
  ###   working_dir: /var/www/iam
  ###   env_file:
  ###     - ./env/.env.iam
  ###   environment:
  ###     APP_ENV: production
  ###     PHP_OPCACHE_VALIDATE_TIMESTAMPS: "0"
  ###     APP_WORKDIR: /var/www/iam
  ###     PUBLIC_VOLUME: /var/www/public-shared-iam
  ###     DB_HOST: database-service
  ###     # IAM Server Configuration - Override from compose
  ###     APP_URL: "http://192.168.1.9:8100"
  ###     SSO_ALLOWED_CLIENTS: "siimut:http://192.168.1.9:8000/sso/callback"
  ###   volumes:
  ###     # Only persistent data, NO CODE mounts
  ###     - iam_storage:/var/www/iam/storage
  ###     - iam_bootstrap_cache:/var/www/iam/bootstrap/cache
  ###     - iam_public:/var/www/public-shared-iam  # Shared with Caddy
  ###   restart: unless-stopped
  ###   deploy:
  ###     resources:
  ###       limits:
  ###         memory: 1.5G
  ###         cpus: "0.7"
  ###       reservations:
  ###         memory: 768M
  ###         cpus: "0.35"
  ###   healthcheck:
  ###     test: ["CMD-SHELL", "php -v >/dev/null 2>&1 && php artisan --version >/dev/null 2>&1"]
  ###     interval: 30s
  ###     timeout: 10s
  ###     retries: 3
  ###     start_period: 60s
  ###   networks:
  ###     default:
  ###       aliases:
  ###         - iam-app

  ####################################################################################################
  ####################################################################################################
  # End Section: Apps - Production Application
  ####################################################################################################
  ####################################################################################################

####################################################################################################
# Named Volumes - Production Optimized (Multi Laravel Apps, No Redis)
####################################################################################################
volumes:
  # Web server data
  nginx_logs:
    driver: local

  # ====== PUBLIC ASSETS (untuk Nginx serve static files) ======
  siimut_public:
    driver: local
  ### iam_public:
  ###   driver: local

  # ====== DATA PERSISTEN LARAVEL (tanpa vendor) ======
  # SIIMUT
  siimut_storage:
    driver: local
  siimut_bootstrap_cache:
    driver: local

  ### # IAM
  ### iam_storage:
  ###   driver: local
  ### iam_bootstrap_cache:
  ###   driver: local

####################################################################################################
# Networks - Production Security
####################################################################################################
networks:
  default:
    name: rsch-srv_default
    external: true